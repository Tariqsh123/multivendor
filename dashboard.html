<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - GlobalMart</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 覆盖层面板样式 */
        .overlay-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 600px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1100;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        
        .overlay-panel.active {
            transform: translateX(0);
        }
        
        .overlay-header {
            padding: 20px;
            background: var(--secondary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .overlay-content {
            padding: 20px;
        }
        
        .overlay-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1099;
            display: none;
        }
        
        .overlay-backdrop.active {
            display: block;
        }
        
        /* 白色关闭按钮 */
        .close-overlay {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }
        
        .close-overlay:hover {
            transform: scale(1.1);
        }
        
        /* 产品价格编辑 */
        .price-edit-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .price-input {
            width: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        
        .original-price {
            text-decoration: line-through;
            color: #999;
            font-size: 0.9rem;
        }
        
        .profit-margin {
            color: #28a745;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        /* 店铺列表 */
        .store-list {
            margin: 15px 0;
        }
        
        .store-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .store-item:last-child {
            border-bottom: none;
        }
        
        .store-price {
            color: var(--secondary);
            font-weight: bold;
        }
        
        /* 佣金详情表格 */
        .commission-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .commission-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #ddd;
        }
        
        .commission-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .commission-table tr:hover {
            background: #f8f9fa;
        }
        
        /* 愿望清单项目 */
        .wishlist-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #eee;
            position: relative;
        }
        
        .remove-wishlist {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }
        
        .dashboard-card {
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        /* 弹窗中的按钮组 */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo"><img src="assets/logo.png" id="logo" alt=""></a>
            
            <div class="nav-menu" id="navMenu">
    <a href="index.html" class="nav-link active">Home</a>
    <a href="about.html" class="nav-link">About</a>
    <a href="products.html" class="nav-link">Products</a>
    <a href="account.html" class="nav-link">Account</a>
    <a href="dashboard.html" class="nav-link dashboard-link" style="display:none;">Dashboard</a>

    <div id="wish-and-cart-menu">
    <!-- Wishlist Icon manually added -->
    <a href="dashboard.html#wishlist" class="nav-link wishlist-icon" id="wishlistIcon">
        <i class="fas fa-heart"></i>
        <span class="wishlist-count">0</span>
    </a>

    <!-- Cart Icon -->
    <a href="#" class="nav-link cart-icon" id="cartIcon">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-count">0</span>
    </a>
    </div>
</div>

            
            <button class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- wishlist cart mobile floating button -->

    <div class="mobile-cart-floating-button">
      <i class="fas fa-shopping-cart"></i>
        <span class="cart-count">0</span>
    </div>

    <div class="mobile-wishlist-floating-button">
      <i class="fas fa-heart"></i>
        <span class="wishlist-count">0</span>
    </div>


    <!-- Dashboard Header -->
    <section class="dashboard-header">
        <div class="container">
            <div class="dashboard-info">
                <h1 id="dashboardTitle">Dashboard</h1>
                <p id="dashboardSubtitle">Welcome to your dashboard</p>
            </div>
            <div class="dashboard-actions">
    <div class="user-info">
        <span id="userName">User</span>
        <span class="user-role" id="userRole">Role</span>
    </div>
    <button class="btn btn-outline" id="logoutBtn" style="margin-left: 15px;">Logout</button>
</div>

        </div>
    </section>

    <!-- Dashboard Content -->
    <section class="dashboard-content">
        <div class="container">
            <!-- Customer Dashboard -->
            <div class="dashboard-section" id="customerDashboard" style="display: none;">
                <div class="dashboard-cards">
                    <div class="dashboard-card" onclick="scrollToSection('recentOrdersSection')">
                        <div class="card-icon customer">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <h3>My Orders</h3>
                        <p>View your order history and track shipments</p>
                        <button class="btn btn-small">View Orders</button>
                    </div>
                    <div class="dashboard-card" onclick="openOverlay('wishlist')">
                        <div class="card-icon customer">
                            <i class="fas fa-heart"></i>
                        </div>
                        <h3>Wishlist</h3>
                        <p>Save products you love for later</p>
                        <button class="btn btn-small">View Wishlist</button>
                    </div>
                    <div class="dashboard-card" onclick="openOverlay('profile')">
                        <div class="card-icon customer">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <h3>Profile</h3>
                        <p>Update your personal information</p>
                        <button class="btn btn-small">Edit Profile</button>
                    </div>
                </div>
                
                <div class="dashboard-main">
                    <h2 id="recentOrdersSection">Recent Orders</h2>
                    <div class="orders-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="customerOrders">
                                <tr>
                                    <td colspan="5" class="no-data">No orders yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <h2>Recommended Products</h2>
                    <div class="products-grid" id="customerProducts">
                        <!-- Recommended products will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Store Manager Dashboard -->
            <div class="dashboard-section" id="managerDashboard" style="display: none;">
                <div class="dashboard-cards">
                    <div class="dashboard-card" id="editStoreCard">
                        <div class="card-icon manager">
                            <i class="fas fa-store"></i>
                        </div>
                        <h3>My Store</h3>
                        <p id="storeNameDisplay">Store: <span id="storeName">My Store</span></p>
                        <button class="btn btn-small" id="editStoreBtn">Edit Store</button>
                    </div>
                    <div class="dashboard-card" onclick="scrollToSection('mystoreTab')">
                        <div class="card-icon manager">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <h3>Manage Products</h3>
                        <p id="productCount">Products: 0</p>
                        <button class="btn btn-small">Manage Products</button>
                    </div>
                    <div class="dashboard-card" onclick="scrollToSection('ordersTab')">
                        <div class="card-icon manager">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Sales</h3>
                        <p>View sales analytics</p>
                        <button class="btn btn-small">View Sales</button>
                    </div>
                </div>
                
                <div class="dashboard-main">
                    <div class="dashboard-tabs">
                        <button class="dash-tab-btn active" data-tab="warehouse">Warehouse Products</button>
                        <button class="dash-tab-btn" data-tab="mystore" id="mystoreTabBtn">My Store Products</button>
                        <button class="dash-tab-btn" data-tab="orders" id="ordersTabBtn">Store Orders</button>
                    </div>
                    
                    <!-- Warehouse Products Tab -->
                    <div class="dash-tab-content active" id="warehouseTab">
                        <h3>Browse Warehouse Products</h3>
                        <p>Select products from the warehouse to add to your store</p>
                        <div class="products-grid" id="warehouseProductsGrid">
                            <!-- Warehouse products will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- My Store Products Tab -->
                    <div class="dash-tab-content" id="mystoreTab">
                        <h3>My Store Products</h3>
                        <button class="btn btn-small" onclick="scrollToSection('warehouseTab')">Add from Warehouse</button>
                        <div class="products-grid" id="myStoreProductsGrid">
                            <!-- Store products will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Store Orders Tab -->
                    <div class="dash-tab-content" id="ordersTab">
                        <h3>Store Orders</h3>
                        <div class="orders-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Product</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="storeOrders">
                                    <tr>
                                        <td colspan="6" class="no-data">No orders yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Shipper Dashboard -->
            <div class="dashboard-section" id="shipperDashboard" style="display: none;">
                <div class="dashboard-cards">
                    <div class="dashboard-card" onclick="scrollToSection('uploadFormSection')">
                        <div class="card-icon shipper">
                            <i class="fas fa-warehouse"></i>
                        </div>
                        <h3>Warehouse</h3>
                        <p>Manage products in warehouse</p>
                        <button class="btn btn-small">Upload Product</button>
                    </div>
                    <div class="dashboard-card" onclick="scrollToSection('myProductsSection')">
                        <div class="card-icon shipper">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <h3>My Products</h3>
                        <p id="shipperProductCount">Products: 0</p>
                        <button class="btn btn-small">View Products</button>
                    </div>
                    <div class="dashboard-card" onclick="openOverlay('commission')">
                        <div class="card-icon shipper">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Commissions</h3>
                        <p id="totalCommission">Total: $0.00</p>
                        <button class="btn btn-small">View Details</button>
                    </div>
                </div>
                
                <div class="dashboard-main">
                    <h2>Upload Product to Warehouse</h2>
                    <div class="upload-form" id="uploadFormSection">
                        <form id="uploadProductForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productName">Product Name</label>
                                    <input type="text" id="productName" required>
                                </div>
                                <div class="form-group">
                                    <label for="productPrice">Price ($)</label>
                                    <input type="number" id="productPrice" step="0.01" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productCategory">Category</label>
                                    <select id="productCategory" required>
                                        <option value="">Select Category</option>
                                        <option value="electronics">Electronics</option>
                                        <option value="clothing">Clothing</option>
                                        <option value="home">Home & Garden</option>
                                        <option value="sports">Sports</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="productCommission">Commission (%)</label>
                                    <input type="number" id="productCommission" min="1" max="50" value="10" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="productDescription">Description</label>
                                <textarea id="productDescription" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="productImage">Image URL</label>
                                <input type="text" id="productImage" placeholder="https://example.com/image.jpg" required>
                                <small>You can use image URLs from Unsplash or other sources</small>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload to Warehouse</button>
                        </form>
                    </div>
                    
                    <h2 id="myProductsSection">My Warehouse Products</h2>
                    <div class="products-grid" id="shipperProductsGrid">
                        <!-- Shipper's products will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Not Logged In Message -->
            <div class="dashboard-section" id="notLoggedIn">
                <div class="auth-message">
                    <i class="fas fa-user-lock"></i>
                    <h2>Access Restricted</h2>
                    <p>You need to be logged in to access the dashboard.</p>
                    <a href="account.html" class="btn btn-primary">Login or Sign Up</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <!-- Keep original footer -->
    </footer>

    <!-- Cart Sidebar -->
    <div class="cart-sidebar" id="cartSidebar">
        <!-- Keep original cart -->
    </div>
    <div class="cart-overlay" id="cartOverlay"></div>

    <!-- 覆盖层面板 -->
    
    <!-- 愿望清单覆盖层 -->
    <div class="overlay-panel" id="wishlistOverlay">
        <div class="overlay-header">
            <h3><i class="fas fa-heart"></i> My Wishlist</h3>
            <button class="close-overlay" data-overlay="wishlist">&times;</button>
        </div>
        <div class="overlay-content" id="wishlistContent">
            <!-- Content loaded dynamically -->
        </div>
    </div>
    
    <!-- 个人资料覆盖层 -->
    <div class="overlay-panel" id="profileOverlay">
        <div class="overlay-header">
            <h3><i class="fas fa-user-circle"></i> My Profile</h3>
            <button class="close-overlay" data-overlay="profile">&times;</button>
        </div>
        <div class="overlay-content" id="profileContent">
            <!-- Content loaded dynamically -->
        </div>
    </div>
    
    <!-- 佣金详情覆盖层 -->
    <div class="overlay-panel" id="commissionOverlay">
        <div class="overlay-header">
            <h3><i class="fas fa-money-bill-wave"></i> Commission Details</h3>
            <button class="close-overlay" data-overlay="commission">&times;</button>
        </div>
        <div class="overlay-content" id="commissionContent">
            <!-- Content loaded dynamically -->
        </div>
    </div>
    
    <!-- 产品价格编辑覆盖层 -->
    <div class="overlay-panel" id="priceEditOverlay">
        <div class="overlay-header">
            <h3><i class="fas fa-tag"></i> Edit Product Price</h3>
            <button class="close-overlay" data-overlay="price">&times;</button>
        </div>
        <div class="overlay-content" id="priceEditContent">
            <!-- Content loaded dynamically -->
        </div>
    </div>
    
    <!-- 店铺详情覆盖层 -->
    <div class="overlay-panel" id="storesOverlay">
        <div class="overlay-header">
            <h3><i class="fas fa-store"></i> Stores Selling This Product</h3>
            <button class="close-overlay" data-overlay="stores">&times;</button>
        </div>
        <div class="overlay-content" id="storesContent">
            <!-- Content loaded dynamically -->
        </div>
    </div>
    
    <div class="overlay-backdrop" id="overlayBackdrop"></div>

    <!-- Modal for store name -->
    <div class="modal" id="storeNameModal">
        <div class="modal-content">
            <h3>Set Your Store Name</h3>
            <p>Enter a name for your store:</p>
            <input type="text" id="storeNameInput" placeholder="e.g., TechZone">
            <div class="modal-buttons">
                <button class="btn btn-primary" id="saveStoreNameBtn">Save</button>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/wishlist.js"></script>
    <script src="js/cart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        updateCartCount();
        loadDashboard();
        setupDashboardTabs();
        setupDashboardEvents();
        setupOverlayEvents();
        
        // Initialize wishlist
        if (typeof initWishlist === 'function') {
            initWishlist();
        }
        
        // Update wishlist count
        if (typeof updateWishlistCount === 'function') {
            updateWishlistCount();
        }
        
        // Check if user is logged in
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'account.html';
            return;
        }
        
        // FIXED: Removed the non-existent logoutBtn event listener that was causing error
        // If you need a logout button, add it to your HTML first
    });
    
    // 通用辅助函数
    function scrollToSection(sectionId) {
        const element = document.getElementById(sectionId);
        if (element) {
            element.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    }
    
    function setupOverlayEvents() {
        // 关闭覆盖层按钮
        document.querySelectorAll('.close-overlay').forEach(button => {
            button.addEventListener('click', function() {
                const overlayId = this.dataset.overlay;
                closeOverlay(overlayId);
            });
        });
        
        // 点击背景关闭覆盖层
        document.getElementById('overlayBackdrop').addEventListener('click', closeAllOverlays);
        
        // ESC键关闭覆盖层
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeAllOverlays();
        });
    }
    
    function openOverlay(overlayId) {
        // 根据覆盖层类型加载内容
        switch(overlayId) {
            case 'wishlist':
                loadWishlist();
                break;
            case 'profile':
                loadProfile();
                break;
            case 'commission':
                loadCommissionDetails();
                break;
        }
        
        const overlayElement = document.getElementById(`${overlayId}Overlay`);
        if (overlayElement) {
            overlayElement.classList.add('active');
        }
        
        document.getElementById('overlayBackdrop').classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function closeOverlay(overlayId) {
        const overlayElement = document.getElementById(`${overlayId}Overlay`);
        if (overlayElement) {
            overlayElement.classList.remove('active');
        }
        document.getElementById('overlayBackdrop').classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    function closeAllOverlays() {
        document.querySelectorAll('.overlay-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        document.getElementById('overlayBackdrop').classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    // 加载愿望清单 - FIXED VERSION
    function loadWishlist() {
        // Use getWishlistItems from wishlist.js if available
        const wishlist = typeof getWishlistItems === 'function' ? getWishlistItems() : JSON.parse(localStorage.getItem('wishlist')) || [];
        const container = document.getElementById('wishlistContent');
        
        if (!container) return;
        
        // Update wishlist count in overlay header
        const countElement = document.getElementById('wishlistCount');
        if (countElement) {
            countElement.textContent = wishlist.length;
        }
        
        if (wishlist.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-heart" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
                    <h3>Your wishlist is empty</h3>
                    <p>Click the heart icon on any product to add it here</p>
                    <a href="products.html" class="btn btn-primary">Browse Products</a>
                </div>
            `;
            return;
        }
        
        let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
        
        wishlist.forEach(item => {
            // FIX: Handle cases where item or its properties might be undefined
            if (!item) return;
            
            const itemId = item.id || Math.random().toString(36).substr(2, 9);
            const itemName = item.name || 'Unknown Product';
            const itemImage = item.image || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80';
            const itemPrice = parseFloat(item.price) || 0;
            const itemStore = item.store || 'GlobalMart';
            const addedAt = item.addedAt ? new Date(item.addedAt).toLocaleDateString() : 'Recently';
            
            html += `
                <div class="wishlist-item">
                    <img src="${itemImage}" alt="${itemName}" 
                         style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;"
                         onerror="this.src='https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80'">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 5px 0;">${itemName}</h4>
                        <div style="color: var(--secondary); font-weight: bold;">$${itemPrice.toFixed(2)}</div>
                        <div style="font-size: 0.9rem; color: #666;">${itemStore}</div>
                        <div style="font-size: 0.8rem; color: #999;">Added ${addedAt}</div>
                    </div>
                    <button class="remove-wishlist" onclick="removeFromWishlistById('${itemId}')" title="Remove from wishlist">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="action-buttons">
                        <button class="btn btn-small" onclick="addToCartFromWishlist('${itemId}')">Add to Cart</button>
                        <a href="products.html" class="btn btn-outline btn-small">View Similar</a>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }
    
    // 从愿望清单移除产品
    function removeFromWishlist(productId) {
        // Use removeFromWishlistById function if available
        if (typeof removeFromWishlistById === 'function') {
            removeFromWishlistById(productId);
        } else {
            let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
            wishlist = wishlist.filter(item => item && item.id != productId);
            localStorage.setItem('wishlist', JSON.stringify(wishlist));
            loadWishlist();
            showToast('Product removed from wishlist');
            
            // Update wishlist count
            if (typeof updateWishlistCount === 'function') {
                updateWishlistCount();
            }
        }
    }
    
    // 从愿望清单添加到购物车
    function addToCartFromWishlist(productId) {
        // Use addToCartFromWishlist from wishlist.js if available
        if (typeof window.addToCartFromWishlist === 'function') {
            window.addToCartFromWishlist(productId);
        } else {
            const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
            const product = wishlist.find(item => item && item.id == productId);
            
            if (product) {
                if (typeof addToCart === 'function') {
                    addToCart(product);
                }
                if (typeof updateCartCount === 'function') {
                    updateCartCount();
                }
                showToast(`${product.name || 'Product'} added to cart!`);
            }
        }
    }
    
    // Remove from wishlist by ID (dashboard specific)
    function removeFromWishlistById(productId) {
        let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
        wishlist = wishlist.filter(item => item && item.id != productId);
        localStorage.setItem('wishlist', JSON.stringify(wishlist));
        
        // Reload wishlist display
        loadWishlist();
        
        // Update wishlist count
        if (typeof updateWishlistCount === 'function') {
            updateWishlistCount();
        }
        
        // Update wishlist buttons on other pages
        if (typeof updateWishlistButtons === 'function') {
            updateWishlistButtons();
        }
        
        showToast('Product removed from wishlist');
    }
    
    // 加载个人资料
    function loadProfile() {
        const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
        const container = document.getElementById('profileContent');
        
        if (!container) return;
        
        container.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 100px; height: 100px; background: var(--secondary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin: 0 auto 20px;">
                    <i class="fas fa-user"></i>
                </div>
                <h3>${currentUser.name || 'User'}</h3>
                <span class="user-role" style="background: var(--secondary); color: white; padding: 5px 15px; border-radius: 20px;">
                    ${currentUser.role ? currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1) : 'User'}
                </span>
            </div>
            
            <div class="profile-info">
                <h4><i class="fas fa-info-circle"></i> Account Information</h4>
                <p><strong>Name:</strong> <span id="profileName">${currentUser.name || 'Not set'}</span></p>
                <p><strong>Email:</strong> ${currentUser.email || 'Not set'}</p>
                <p><strong>Phone:</strong> ${currentUser.phone || 'Not set'}</p>
                <p><strong>Joined:</strong> ${currentUser.createdAt ? new Date(currentUser.createdAt).toLocaleDateString() : 'Not available'}</p>
            </div>
            
            <h4><i class="fas fa-edit"></i> Edit Profile</h4>
            <p style="color: #666; margin-bottom: 15px;">You can only change your name. Contact support for other changes.</p>
            <div class="profile-form">
                <input type="text" id="editUserName" value="${currentUser.name || ''}" placeholder="Enter your name" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="updateUserName()">Update Name</button>
            </div>
        `;
    }
    
    // 更新用户名
    function updateUserName() {
        const newNameInput = document.getElementById('editUserName');
        if (!newNameInput) return;
        
        const newName = newNameInput.value.trim();
        if (!newName) {
            alert('Please enter a valid name');
            return;
        }
        
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) return;
        
        currentUser.name = newName;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        // 更新所有显示的名称
        document.querySelectorAll('#userName, #profileName').forEach(el => {
            el.textContent = newName;
        });
        
        showToast('Name updated successfully!');
    }
    
    // 加载佣金详情
    function loadCommissionDetails() {
        const warehouseProducts = JSON.parse(localStorage.getItem('warehouseProducts')) || [];
        const storeProducts = JSON.parse(localStorage.getItem('storeProducts')) || [];
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const container = document.getElementById('commissionContent');
        
        if (!container) return;
        
        if (!currentUser || currentUser.role !== 'shipper') {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-user-lock" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
                    <h3>Access Denied</h3>
                    <p>Commission details are only available for shippers</p>
                </div>
            `;
            return;
        }
        
        const shipperProducts = warehouseProducts.filter(p => p && p.shipperId === currentUser.id);
        
        if (shipperProducts.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-money-bill-wave" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
                    <h3>No commission data</h3>
                    <p>Upload products to start earning commissions</p>
                </div>
            `;
            return;
        }
        
        let totalCommission = 0;
        let totalSales = 0;
        
        let html = `
            <h4>Commission Summary</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Total Products:</span>
                    <strong>${shipperProducts.length}</strong>
                </div>
        `;
        
        shipperProducts.forEach(product => {
            if (!product) return;
            
            const storeCount = storeProducts.filter(sp => sp && sp.warehouseId === product.id).length;
            const productSales = (product.sold || 0) * (parseFloat(product.price) || 0);
            const commissionRate = parseFloat(product.commission) || 10;
            const productCommission = productSales * (commissionRate / 100);
            
            totalSales += productSales;
            totalCommission += productCommission;
            
            html += `
                <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>${product.name || 'Unknown Product'}</span>
                        <strong>$${productCommission.toFixed(2)}</strong>
                    </div>
                    <div style="font-size: 0.9rem; color: #666;">
                        Sold: ${product.sold || 0} units | In ${storeCount} stores
                        <button class="btn btn-small" style="margin-left: 10px; padding: 2px 8px; font-size: 0.8rem;" 
                                onclick="viewProductStores('${product.id}')">View Stores</button>
                    </div>
                </div>
            `;
        });
        
        html += `
                <div style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 10px; font-weight: bold;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Total Commission:</span>
                        <strong style="color: var(--secondary);">$${totalCommission.toFixed(2)}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                        <span>Total Sales:</span>
                        <span>$${totalSales.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    // 查看哪些店铺添加了产品
    function viewProductStores(productId) {
        const warehouseProducts = JSON.parse(localStorage.getItem('warehouseProducts')) || [];
        const storeProducts = JSON.parse(localStorage.getItem('storeProducts')) || [];
        const product = warehouseProducts.find(p => p && p.id == productId);
        const container = document.getElementById('storesContent');
        
        if (!container) return;
        
        if (!product) {
            container.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #ccc; margin-bottom: 10px;"></i>
                    <p>Product not found</p>
                </div>
            `;
            return;
        }
        
        const stores = storeProducts.filter(sp => sp && sp.warehouseId == productId);
        
        let html = `
            <div style="margin-bottom: 20px;">
                <h4>${product.name || 'Unknown Product'}</h4>
                <p style="color: #666;">Original Price: $${(parseFloat(product.price) || 0).toFixed(2)} | Commission: ${product.commission || 10}%</p>
            </div>
        `;
        
        if (stores.length === 0) {
            html += `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-store-slash" style="font-size: 2rem; color: #ccc; margin-bottom: 10px;"></i>
                    <p>No stores have added this product yet</p>
                </div>
            `;
        } else {
            html += '<h5>Stores Selling This Product:</h5>';
            html += '<div class="store-list">';
            
            stores.forEach(storeProduct => {
                if (!storeProduct) return;
                
                const warehousePrice = parseFloat(product.price) || 0;
                const storePrice = parseFloat(storeProduct.price) || 0;
                const markup = warehousePrice > 0 ? ((storePrice - warehousePrice) / warehousePrice * 100).toFixed(1) : '0.0';
                
                html += `
                    <div class="store-item">
                        <div>
                            <strong>${storeProduct.store || 'Unknown Store'}</strong>
                            <div style="font-size: 0.9rem; color: #666;">Store Price: $${storePrice.toFixed(2)}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="store-price">$${storePrice.toFixed(2)}</div>
                            <div style="font-size: 0.8rem; color: #28a745;">+${markup}% markup</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        container.innerHTML = html;
        openOverlay('stores');
    }
    
    // 编辑产品价格（经理功能）
    function editProductPrice(productId) {
        const storeProducts = JSON.parse(localStorage.getItem('storeProducts')) || [];
        const warehouseProducts = JSON.parse(localStorage.getItem('warehouseProducts')) || [];
        const container = document.getElementById('priceEditContent');
        
        if (!container) return;
        
        const storeProduct = storeProducts.find(p => p && p.id == productId);
        const warehouseProduct = warehouseProducts.find(p => p && p.id == storeProduct?.warehouseId);
        
        if (!storeProduct || !warehouseProduct) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #ccc; margin-bottom: 10px;"></i>
                    <p>Product not found</p>
                </div>
            `;
            return;
        }
        
        const warehousePrice = parseFloat(warehouseProduct.price) || 0;
        const currentPrice = parseFloat(storeProduct.price) || warehousePrice;
        
        container.innerHTML = `
            <div style="margin-bottom: 20px;">
                <h4>${storeProduct.name || 'Unknown Product'}</h4>
                <p style="color: #666;">Warehouse Price: $${warehousePrice.toFixed(2)}</p>
            </div>
            
            <div class="price-edit-container">
                <label>Your Store Price:</label>
                <input type="number" id="newProductPrice" class="price-input" 
                       value="${currentPrice.toFixed(2)}" step="0.01" min="${warehousePrice}">
                <span>USD</span>
            </div>
            
            <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <p><strong>Current Price:</strong> $${currentPrice.toFixed(2)}</p>
                <p><strong>Warehouse Price:</strong> <span class="original-price">$${warehousePrice.toFixed(2)}</span></p>
                <p><strong>Your Markup:</strong> <span class="profit-margin" id="markupDisplay">
                    ${warehousePrice > 0 ? (((currentPrice - warehousePrice) / warehousePrice * 100) || 0).toFixed(1) : '0.0'}%
                </span></p>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="saveProductPrice('${productId}')">Save Price</button>
                <button class="btn btn-outline" onclick="closeOverlay('price')">Cancel</button>
            </div>
        `;
        
        // 实时更新加价百分比
        const priceInput = document.getElementById('newProductPrice');
        if (priceInput) {
            priceInput.addEventListener('input', function() {
                const newPrice = parseFloat(this.value) || warehousePrice;
                const markup = warehousePrice > 0 ? ((newPrice - warehousePrice) / warehousePrice * 100).toFixed(1) : '0.0';
                const markupDisplay = document.getElementById('markupDisplay');
                if (markupDisplay) {
                    markupDisplay.textContent = `${markup}%`;
                }
            });
        }
        
        openOverlay('price');
    }
    
    // 保存产品价格
    function saveProductPrice(productId) {
        const priceInput = document.getElementById('newProductPrice');
        if (!priceInput) return;
        
        const newPrice = parseFloat(priceInput.value);
        if (!newPrice || newPrice < 0) {
            alert('Please enter a valid price');
            return;
        }
        
        const storeProducts = JSON.parse(localStorage.getItem('storeProducts')) || [];
        const productIndex = storeProducts.findIndex(p => p && p.id == productId);
        
        if (productIndex === -1) {
            alert('Product not found');
            return;
        }
        
        const warehouseProducts = JSON.parse(localStorage.getItem('warehouseProducts')) || [];
        const warehouseProduct = warehouseProducts.find(p => p && p.id == storeProducts[productIndex].warehouseId);
        
        const warehousePrice = warehouseProduct ? parseFloat(warehouseProduct.price) || 0 : 0;
        
        if (!warehouseProduct || newPrice < warehousePrice) {
            alert(`Price must be at least $${warehousePrice.toFixed(2)} (warehouse price)`);
            return;
        }
        
        storeProducts[productIndex].price = newPrice;
        localStorage.setItem('storeProducts', JSON.stringify(storeProducts));
        
        // 重新加载产品列表
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser?.role === 'manager') {
            if (typeof loadManagerStoreProducts === 'function') {
                loadManagerStoreProducts(currentUser);
            }
        }
        
        closeOverlay('price');
        showToast('Price updated successfully!');
    }
    
    // 显示通知
    function showToast(message) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--secondary);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease;
            font-weight: 500;
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (toast.parentNode) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }
    
    // Clear wishlist from dashboard
    function clearWishlist() {
        if (confirm('Are you sure you want to clear your entire wishlist?')) {
            localStorage.setItem('wishlist', JSON.stringify([]));
            
            // Reload wishlist display
            loadWishlist();
            
            // Update wishlist count
            if (typeof updateWishlistCount === 'function') {
                updateWishlistCount();
            }
            
            // Update wishlist buttons on other pages
            if (typeof updateWishlistButtons === 'function') {
                updateWishlistButtons();
            }
            
            showToast('Wishlist cleared');
        }
    }
    
    // 动画样式
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100px); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            localStorage.removeItem('currentUser'); // clear user session
            window.location.href = 'account.html'; // redirect to login page
        });
    }
</script>
</body>
</html>